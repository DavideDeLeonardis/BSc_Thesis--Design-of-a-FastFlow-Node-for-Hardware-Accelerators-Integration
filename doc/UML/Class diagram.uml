@startuml
'--- Stile ---
allow_mixing
skinparam classAttributeIconSize 0
skinparam classFontSize 10
skinparam classAttributeFontSize 9
skinparam classOperationFontSize 9
skinparam linetype ortho
'--- Colori per i ruoli ---
skinparam interface {
  BackgroundColor LightBlue
  BorderColor Blue
}
skinparam class {
  BackgroundColor PaleGreen
}
skinparam abstract {
  BackgroundColor LightYellow
}
' Colore per DTOs / Structs
skinparam stereotype {
  BackgroundColor Wheat
  BorderColor Orange
}

' === 1. Il Client (main) e la Factory ===
' Package rimosso come da richiesta
class MAIN {
  + main()
}

class DeviceRunner_Factory <<factory>> {
  + {static} create_runner_for_device(type, ...) : IDeviceRunner*
}


' === 2. L'Interfaccia Comune e le Struct Dati ===
package "Interfaccia Comune" {
  interface IDeviceRunner {
    + {abstract} execute(N, NUM_TASKS) : ComputeResult
  }

  class ComputeResult <<struct>> {
    + elapsed_ns : long long
    + computed_ns : long long
    + tasks_completed : size_t
  }

  class Task <<struct>> {
    + a, b, *c : int*
    + n : size_t
    + id : size_t
    + buffer_idx : size_t
    + arrival_time: time_point
  }
  
  IDeviceRunner ..> ComputeResult : "restituisce"
}

' === 3. Famiglia 1: Strategie CPU ===
package "Strategie CPU" {
  abstract class AbstractCpuRunner <<strategy>> {
    # {abstract} execute_parallel_loop(start, end)
    # execute_kernel_work(i)
    ---
    + execute(N, NUM_TASKS) : ComputeResult
  }
  class Cpu_OMP_Runner {
    # execute_parallel_loop(start, end)
  }
  class Cpu_FF_Runner {
    # execute_parallel_loop(start, end)
  }
}

' === 4. Famiglia 2: Strategie Acceleratore (Adattatore) ===
package "Strategie Acceleratore" {
  class AcceleratorPipelineRunner <<strategy>>/<<adapter>> {
    - accelerator : IAccelerator*
    ---
    + execute(N, NUM_TASKS) : ComputeResult
  }
  
  class ff_node_acc_t {
    - accelerator_ : IAccelerator*
    - stats_ : StatsCollector*
    ---
    + svc_init()
    + svc(Task*)
    + svc_end()
    + procucerLoop()
    + consumerLoop()
  }

  class StatsCollector <<struct>> {
    + tasks_processed : atomic
    + count_promise : promise
    + computed_ns : atomic
    + total_InNode_time_ns : atomic
    + inter_completion_time_ns : atomic
  }
}

' === 5. Famiglia 3: Logica Hardware (Il tuo codice) ===
package "Logica Hardware (IAccelerator)" {
  interface IAccelerator {
    + {abstract} initialize()
    + {abstract} send_data_to_device(Task*)
    + {abstract} execute_kernel(Task*)
    + {abstract} get_results_from_device(Task*, &ns)
  }
  
  class Gpu_OpenCL_Accelerator
  class Fpga_Accelerator
  class Gpu_Metal_Accelerator
  
  IAccelerator <|-- Gpu_OpenCL_Accelerator
  IAccelerator <|-- Fpga_Accelerator
  IAccelerator <|-- Gpu_Metal_Accelerator
}


' === Relazioni Principali (collegano i package) ===
MAIN ..> DeviceRunner_Factory : "usa"
MAIN ..> IDeviceRunner : "usa"
DeviceRunner_Factory ..> IDeviceRunner : "crea"

' Le strategie implementano l'interfaccia
IDeviceRunner <|-- AbstractCpuRunner
IDeviceRunner <|-- AcceleratorPipelineRunner

' Dettagli implementazione CPU
AbstractCpuRunner <|-- Cpu_OMP_Runner
AbstractCpuRunner <|-- Cpu_FF_Runner

' Dettagli implementazione Acceleratore
AcceleratorPipelineRunner o-- "1" IAccelerator : "adatta->"
AcceleratorPipelineRunner ..> ff_node_acc_t : "crea e usa"
AcceleratorPipelineRunner ..> StatsCollector : "crea->"
ff_node_acc_t ..> IAccelerator : "usa"
ff_node_acc_t ..> StatsCollector : "usa (aggiorna)"

' Queste frecce "all'indietro" non influenzano il layout
ff_node_acc_t ..up..> Task : "processa ->"
IAccelerator ..up..> Task : "opera su -->"


' === FORZATURA LAYOUT (con "together") ===
' Questo raggruppa le due strategie sulla stessa riga

' Riga 1 -> Riga 2 (Agganciato a "main" invece che "Client")
MAIN -[hidden]down- "Interfaccia Comune"

' Raggruppa le due strategie sulla stessa riga
together {
  package "Strategie CPU"
  package "Strategie Acceleratore"
}

' Riga 2 -> Riga 3 (collegando al gruppo)
"Interfaccia Comune" -[hidden]down- "Strategie CPU"

' Riga 3 -> Riga 4
"Strategie Acceleratore" -[hidden]down- "Logica Hardware (IAccelerator)"

' Allineamento finale per tenere la griglia
"Strategie CPU" -[hidden]right- "Logica Hardware (IAccelerator)"

@enduml