// TESI: Integrazione FPGA in FastFlow

Si propone di realizzare un semplice prototipo per l'integrazione di kernel programmati su FPGA Alveo mediante Vitis (sostanzialmente kernel scritti in C/C++) nell'ambiente di programmazione FastFlow. Verranno utilizzati kernel esistenti.
L'obiettivo della tesi sarà quello di interfacciare i kernel mediante codice OpenCL sfruttando tutte le possibilità offerte da tale ambiente. L'integrazione in FastFlow dovrà permettere di utilizzare sia il classico parallelismo shared memory/thread sulla CPU multicore che l'offloading di computazioni pesanti sull'acceleratore FPGA.


FastFlow:
   https://github.com/fastflow/fastflow

Parte di colloquio con l'acceleratore vedi VITIS XILINX:
	https://docs.amd.com/r/en-US/Vitis-Tutorials-Getting-Started/Vitis-Introduction-and-Getting-Started

Per usarla con GPU (OpenCL)
    https://eunomia.dev/en/others/cuda-tutorial/15-opencl-vector-addition/

L'account è deleonardis, la macchina è pianosa.di.unipi.it, address: 131.114.3.250
   ssh -Y deleonardis@131.114.3.250


// ----------------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------- COMPILING, LINKING, EXEC, Install FF, SYNC MacOS with host LINUX --------------------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------------------------------------------------------------------
// BUILD AND EXEC:
   rm -rf build; cmake -B build && cmake --build build && ./build/tesi-exec 1000000 7 gpu

// Install correct FF Version on VM:
   rm -rf external/fastflow; git clone https://github.com/fastflow/fastflow.git external/fastflow

// SYNC Mac files with host pianosa
   rsync -av --exclude={'build/','.DS_Store','.git/','.gitignore','.vscode/','General/','external/','measurement/Measurements.csv'} /Users/davidedeleonardis/Desktop/Developer/Progettazione\ di\ un\ nodo\ FastFlow\ per\ integrazione\ di\ acceleratori\ -\ TESI\ Unipi/ deleonardis@131.114.3.250:~/Tesi--Progettazione_di_un_nodo_Fastflow_per_integrazione_di_acceleratori/

// COMPILAZIONE E LINKING SU FPGA per ottenere xclbin (in dir Tesi)
   unset XCL_EMULATION_MODE
   v++ -c -k krnl_heavy_compute_parallel --platform xilinx_u50_gen3x16_xdma_5_202210_1 --target hw -o kernels/fpga/krnl_heavy_compute_parallel.xo kernels/fpga/krnl_heavy_compute_parallel.cpp
   v++ -l --platform xilinx_u50_gen3x16_xdma_5_202210_1 --target hw -o kernels/fpga/krnl_heavy_compute_parallel.xclbin kernels/fpga/krnl_heavy_compute_parallel.xo

   NON CREA IL FILE xrt.run_summary ---- Linking con profiling per vitis_analyzer (vitis_analyzer --classic xrt.run_summary)
      v++ -l --platform xilinx_u50_gen3x16_xdma_5_202210_1 --target hw --profile.data all:all:all -o krnl_vadd.xclbin kernels/krnl_vadd.xo


// COMPILAZIONE E LINKING SU FPGA se voglio usare SOFTWARE EMULATION per ottenere xclbin (in dir Tesi) + EXEC --------> OK!
   v++ -c -k krnl_vadd --platform xilinx_u50_gen3x16_xdma_5_202210_1 --target sw_emu -o kernels/krnl_vadd.sw_emu.xo kernels/krnl_vadd.cpp
   v++ -l --platform xilinx_u50_gen3x16_xdma_5_202210_1 --target sw_emu -o krnl_vadd.sw_emu.xclbin kernels/krnl_vadd.sw_emu.xo

   export XCL_EMULATION_MODE=sw_emu
   Modifica nome .xclbin in Fpga_Accelerator in kernels/krnl_vadd.sw_emu.xclbin
   rm -rf build; cmake -B build && cmake --build build && ./build/tesi-exec 1000000 7 fpga

// COMPILAZIONE E LINKING SU FPGA se voglio usare HARDWARE EMULATION per ottenere xclbin (in dir Tesi) ----> e poi voglio usare VITIS ANALYZER       (Usa N piccoli)    ----> NON FUNZIONA!
   v++ -c -k krnl_vadd --platform xilinx_u50_gen3x16_xdma_5_202210_1 --target hw_emu -o kernels/krnl_vadd.hw_emu.xo kernels/krnl_vadd.cpp
   v++ -l --platform xilinx_u50_gen3x16_xdma_5_202210_1 --target hw_emu --vivado.prop "run.my_run.is_locked=false" -o krnl_vadd.hw_emu.xclbin kernels/krnl_vadd.hw_emu.xo
      ERRORS:
         "IP ... is locked": Un componente hardware pre-costruito della sua piattaforma (pfm_top...) è "bloccato".
         "customized with software release 2022.1": Questo componente è stato creato e testato con la versione 2022.1 degli strumenti Xilinx.
         "has a different revision in the IP Catalog": La versione degli strumenti Vitis/Vivado che sta usando attualmente (probabilmente una più recente come la 2023.x) ha una versione più nuova di quel componente.
   export XCL_EMULATION_MODE=hw_emu
   Modifica nome .xclbin in Fpga_Accelerator in kernels/krnl_vadd.hw_emu.xclbin
   rm -rf build; cmake -B build && cmake --build build && ./build/tesi-exec 1000000 7 fpga
   vitis_analyzer xrt.run_summary
// ----------------------------------------------------------------------------------------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------------------------------------------------------------------



// ----------------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------- TERMINAL SESSIONS -------------------------------------------------------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------------------------------------------------------------------
Start session:
   screen -S vitis

Resume session:
   screen -r vitis   

See sessions:
   screen -ls

Delete session:
   screen -X -S [session # you want to kill] kill
   
Per ritornare in terminale da sessione:
   ctrl-a
   d
// ----------------------------------------------------------------------------------------------------------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------------------------------------------------------------------